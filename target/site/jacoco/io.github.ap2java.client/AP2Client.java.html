<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AP2Client.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AP2Java</a> &gt; <a href="index.source.html" class="el_package">io.github.ap2java.client</a> &gt; <span class="el_source">AP2Client.java</span></div><h1>AP2Client.java</h1><pre class="source lang-java linenums">package io.github.ap2java.client;

import io.github.ap2java.domain.EnhancedMessage;
import io.github.ap2java.domain.EnhancedTask;
import io.github.ap2java.domain.PaymentEnabledAgentCard;
import io.github.ap2java.domain.PaymentRequest;
import io.github.ap2java.domain.PaymentResponse;
import io.github.ap2java.payment.PaymentProcessor;
import io.github.vishalmysore.a2a.domain.AgentCard;
import io.github.vishalmysore.a2a.domain.Message;
import io.github.vishalmysore.a2a.domain.Task;
import lombok.extern.slf4j.Slf4j;

import java.util.concurrent.CompletableFuture;

/**
 * Client for interacting with payment-enabled agents.
 */
<span class="nc" id="L19">@Slf4j</span>
public class AP2Client {
    
    private static final String METHOD_CREATE_PAYMENT = &quot;createPayment&quot;;
    private static final String METHOD_AUTHORIZE_PAYMENT = &quot;authorizePayment&quot;;
    private static final String METHOD_CAPTURE_PAYMENT = &quot;capturePayment&quot;;
    private static final String METHOD_CANCEL_PAYMENT = &quot;cancelPayment&quot;;
    private static final String METHOD_CHECK_STATUS = &quot;checkPaymentStatus&quot;;
    
    private final PaymentProcessor paymentProcessor;
    private final PaymentEnabledAgentCard agentCard;
    
    /**
     * Constructor.
     *
     * @param paymentProcessor The payment processor implementation.
     * @param agentCard        The payment-enabled agent card.
     */
<span class="nc" id="L37">    public AP2Client(PaymentProcessor paymentProcessor, PaymentEnabledAgentCard agentCard) {</span>
<span class="nc" id="L38">        this.paymentProcessor = paymentProcessor;</span>
<span class="nc" id="L39">        this.agentCard = agentCard;</span>
<span class="nc" id="L40">    }</span>
    
    /**
     * Create a new payment.
     *
     * @param paymentRequest The payment request.
     * @return A future with the payment response.
     */
    public CompletableFuture&lt;PaymentResponse&gt; createPayment(PaymentRequest paymentRequest) {
<span class="nc" id="L49">        log.info(&quot;Creating payment: {}&quot;, paymentRequest);</span>
<span class="nc" id="L50">        return paymentProcessor.createPayment(paymentRequest);</span>
    }
    
    /**
     * Authorize a payment.
     *
     * @param paymentId The ID of the payment to authorize.
     * @param authToken The authorization token.
     * @return A future with the payment response.
     */
    public CompletableFuture&lt;PaymentResponse&gt; authorizePayment(String paymentId, String authToken) {
<span class="nc" id="L61">        log.info(&quot;Authorizing payment: {}&quot;, paymentId);</span>
<span class="nc" id="L62">        return paymentProcessor.authorizePayment(paymentId, authToken);</span>
    }
    
    /**
     * Capture a payment.
     *
     * @param paymentId The ID of the payment to capture.
     * @return A future with the payment response.
     */
    public CompletableFuture&lt;PaymentResponse&gt; capturePayment(String paymentId) {
<span class="nc" id="L72">        log.info(&quot;Capturing payment: {}&quot;, paymentId);</span>
<span class="nc" id="L73">        return paymentProcessor.capturePayment(paymentId);</span>
    }
    
    /**
     * Cancel a payment.
     *
     * @param paymentId The ID of the payment to cancel.
     * @return A future with the payment response.
     */
    public CompletableFuture&lt;PaymentResponse&gt; cancelPayment(String paymentId) {
<span class="nc" id="L83">        log.info(&quot;Cancelling payment: {}&quot;, paymentId);</span>
<span class="nc" id="L84">        return paymentProcessor.cancelPayment(paymentId);</span>
    }
    
    /**
     * Check the status of a payment.
     *
     * @param paymentId The ID of the payment to check.
     * @return A future with the payment response.
     */
    public CompletableFuture&lt;PaymentResponse&gt; checkPaymentStatus(String paymentId) {
<span class="nc" id="L94">        log.info(&quot;Checking payment status: {}&quot;, paymentId);</span>
<span class="nc" id="L95">        return paymentProcessor.checkPaymentStatus(paymentId);</span>
    }
    
    /**
     * Get the agent card associated with this client.
     *
     * @return The agent card.
     */
    public AgentCard getAgentCard() {
<span class="nc" id="L104">        return agentCard;</span>
    }
    
    /**
     * Process a message from another agent.
     * This method is intended to be used when integrating with the a2ajava messaging system.
     *
     * @param message The message to process.
     * @return A task representing the operation.
     */
    public Task processMessage(Message message) {
<span class="nc" id="L115">        log.info(&quot;Processing message: {}&quot;, message);</span>
        
        // Convert to enhanced message if it's not already
        EnhancedMessage enhancedMessage;
<span class="nc bnc" id="L119" title="All 2 branches missed.">        if (message instanceof EnhancedMessage) {</span>
<span class="nc" id="L120">            enhancedMessage = (EnhancedMessage) message;</span>
        } else {
<span class="nc" id="L122">            enhancedMessage = new EnhancedMessage();</span>
            // Copy properties from original message
<span class="nc" id="L124">            enhancedMessage.setId(message.getId());</span>
<span class="nc" id="L125">            enhancedMessage.setRole(message.getRole());</span>
<span class="nc" id="L126">            enhancedMessage.setParts(message.getParts());</span>
<span class="nc" id="L127">            enhancedMessage.setMetadata(message.getMetadata());</span>
        }
        
        // Create a task to track the operation
<span class="nc" id="L131">        EnhancedTask task = new EnhancedTask();</span>
<span class="nc" id="L132">        task.setId(enhancedMessage.getId());</span>
        
        // Process the message based on its method
<span class="nc" id="L135">        String method = enhancedMessage.getMethod();</span>
        
<span class="nc bnc" id="L137" title="All 2 branches missed.">        if (METHOD_CREATE_PAYMENT.equals(method)) {</span>
            // Extract payment request from message
<span class="nc" id="L139">            PaymentRequest paymentRequest = extractPaymentRequest(message);</span>
            
            // Create the payment
<span class="nc" id="L142">            createPayment(paymentRequest)</span>
<span class="nc" id="L143">                    .thenAccept(response -&gt; {</span>
                        // Update task with response
<span class="nc" id="L145">                        task.setCompleted(true);</span>
<span class="nc" id="L146">                        task.setResult(response);</span>
<span class="nc" id="L147">                    })</span>
<span class="nc" id="L148">                    .exceptionally(ex -&gt; {</span>
                        // Handle error
<span class="nc" id="L150">                        task.setCompleted(true);</span>
<span class="nc" id="L151">                        task.setError(ex.getMessage());</span>
<span class="nc" id="L152">                        return null;</span>
                    });
<span class="nc bnc" id="L154" title="All 2 branches missed.">        } else if (METHOD_AUTHORIZE_PAYMENT.equals(method)) {</span>
            // Extract parameters from message
<span class="nc" id="L156">            String paymentId = extractString(message, &quot;paymentId&quot;);</span>
<span class="nc" id="L157">            String authToken = extractString(message, &quot;authToken&quot;);</span>
            
            // Authorize the payment
<span class="nc" id="L160">            authorizePayment(paymentId, authToken)</span>
<span class="nc" id="L161">                    .thenAccept(response -&gt; {</span>
                        // Update task with response
<span class="nc" id="L163">                        task.setCompleted(true);</span>
<span class="nc" id="L164">                        task.setResult(response);</span>
<span class="nc" id="L165">                    })</span>
<span class="nc" id="L166">                    .exceptionally(ex -&gt; {</span>
                        // Handle error
<span class="nc" id="L168">                        task.setCompleted(true);</span>
<span class="nc" id="L169">                        task.setError(ex.getMessage());</span>
<span class="nc" id="L170">                        return null;</span>
                    });
<span class="nc bnc" id="L172" title="All 2 branches missed.">        } else if (METHOD_CAPTURE_PAYMENT.equals(method)) {</span>
            // Extract parameters from message
<span class="nc" id="L174">            String paymentId = extractString(message, &quot;paymentId&quot;);</span>
            
            // Capture the payment
<span class="nc" id="L177">            capturePayment(paymentId)</span>
<span class="nc" id="L178">                    .thenAccept(response -&gt; {</span>
                        // Update task with response
<span class="nc" id="L180">                        task.setCompleted(true);</span>
<span class="nc" id="L181">                        task.setResult(response);</span>
<span class="nc" id="L182">                    })</span>
<span class="nc" id="L183">                    .exceptionally(ex -&gt; {</span>
                        // Handle error
<span class="nc" id="L185">                        task.setCompleted(true);</span>
<span class="nc" id="L186">                        task.setError(ex.getMessage());</span>
<span class="nc" id="L187">                        return null;</span>
                    });
<span class="nc bnc" id="L189" title="All 2 branches missed.">        } else if (METHOD_CANCEL_PAYMENT.equals(method)) {</span>
            // Extract parameters from message
<span class="nc" id="L191">            String paymentId = extractString(message, &quot;paymentId&quot;);</span>
            
            // Cancel the payment
<span class="nc" id="L194">            cancelPayment(paymentId)</span>
<span class="nc" id="L195">                    .thenAccept(response -&gt; {</span>
                        // Update task with response
<span class="nc" id="L197">                        task.setCompleted(true);</span>
<span class="nc" id="L198">                        task.setResult(response);</span>
<span class="nc" id="L199">                    })</span>
<span class="nc" id="L200">                    .exceptionally(ex -&gt; {</span>
                        // Handle error
<span class="nc" id="L202">                        task.setCompleted(true);</span>
<span class="nc" id="L203">                        task.setError(ex.getMessage());</span>
<span class="nc" id="L204">                        return null;</span>
                    });
<span class="nc bnc" id="L206" title="All 2 branches missed.">        } else if (METHOD_CHECK_STATUS.equals(method)) {</span>
            // Extract parameters from message
<span class="nc" id="L208">            String paymentId = extractString(message, &quot;paymentId&quot;);</span>
            
            // Check payment status
<span class="nc" id="L211">            checkPaymentStatus(paymentId)</span>
<span class="nc" id="L212">                    .thenAccept(response -&gt; {</span>
                        // Update task with response
<span class="nc" id="L214">                        task.setCompleted(true);</span>
<span class="nc" id="L215">                        task.setResult(response);</span>
<span class="nc" id="L216">                    })</span>
<span class="nc" id="L217">                    .exceptionally(ex -&gt; {</span>
                        // Handle error
<span class="nc" id="L219">                        task.setCompleted(true);</span>
<span class="nc" id="L220">                        task.setError(ex.getMessage());</span>
<span class="nc" id="L221">                        return null;</span>
                    });
<span class="nc" id="L223">        } else {</span>
            // Unsupported method
<span class="nc" id="L225">            task.setCompleted(true);</span>
<span class="nc" id="L226">            task.setError(&quot;Unsupported method: &quot; + method);</span>
        }
        
<span class="nc" id="L229">        return task;</span>
    }
    
    /**
     * Helper method to extract a payment request from a message.
     *
     * @param message The message containing the payment request.
     * @return The extracted payment request.
     */
    private PaymentRequest extractPaymentRequest(Message message) {
        // Convert to enhanced message if it's not already
        EnhancedMessage enhancedMessage;
<span class="nc bnc" id="L241" title="All 2 branches missed.">        if (message instanceof EnhancedMessage) {</span>
<span class="nc" id="L242">            enhancedMessage = (EnhancedMessage) message;</span>
        } else {
<span class="nc" id="L244">            enhancedMessage = new EnhancedMessage();</span>
            // Copy properties from original message
<span class="nc" id="L246">            enhancedMessage.setId(message.getId());</span>
<span class="nc" id="L247">            enhancedMessage.setRole(message.getRole());</span>
<span class="nc" id="L248">            enhancedMessage.setParts(message.getParts());</span>
<span class="nc" id="L249">            enhancedMessage.setMetadata(message.getMetadata());</span>
        }
        
        // In a real implementation, this would deserialize the message payload
        // into a PaymentRequest object. For simplicity, we return a dummy object.
<span class="nc" id="L254">        return PaymentRequest.builder().build();</span>
    }
    
    /**
     * Helper method to extract a string parameter from a message.
     *
     * @param message The message containing the parameter.
     * @param key     The parameter key.
     * @return The extracted string value.
     */
    private String extractString(Message message, String key) {
        // Convert to enhanced message if it's not already
        EnhancedMessage enhancedMessage;
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (message instanceof EnhancedMessage) {</span>
<span class="nc" id="L268">            enhancedMessage = (EnhancedMessage) message;</span>
        } else {
<span class="nc" id="L270">            enhancedMessage = new EnhancedMessage();</span>
            // Copy properties from original message
<span class="nc" id="L272">            enhancedMessage.setId(message.getId());</span>
<span class="nc" id="L273">            enhancedMessage.setRole(message.getRole());</span>
<span class="nc" id="L274">            enhancedMessage.setParts(message.getParts());</span>
<span class="nc" id="L275">            enhancedMessage.setMetadata(message.getMetadata());</span>
        }
        // In a real implementation, this would extract the parameter from the message.
        // For simplicity, we return a dummy value.
<span class="nc" id="L279">        return &quot;dummy-value&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>