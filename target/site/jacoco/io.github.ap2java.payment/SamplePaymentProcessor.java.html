<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SamplePaymentProcessor.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">AP2Java</a> &gt; <a href="index.source.html" class="el_package">io.github.ap2java.payment</a> &gt; <span class="el_source">SamplePaymentProcessor.java</span></div><h1>SamplePaymentProcessor.java</h1><pre class="source lang-java linenums">package io.github.ap2java.payment;

import io.github.ap2java.domain.Payment;
import io.github.ap2java.domain.PaymentRequest;
import io.github.ap2java.domain.PaymentResponse;
import io.github.ap2java.domain.PaymentStatus;
import lombok.extern.slf4j.Slf4j;

import java.time.Instant;
import java.util.HashMap;
import java.util.Map;
import java.util.Optional;
import java.util.UUID;
import java.util.concurrent.CompletableFuture;

/**
 * Sample implementation of the PaymentProcessor interface.
 */
<span class="fc" id="L19">@Slf4j</span>
<span class="fc" id="L20">public class SamplePaymentProcessor implements PaymentProcessor {</span>
    
<span class="fc" id="L22">    private final Map&lt;String, Payment&gt; paymentStore = new HashMap&lt;&gt;();</span>
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; createPayment(PaymentRequest paymentRequest) {
<span class="fc" id="L26">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L27">            log.info(&quot;Creating payment for request: {}&quot;, paymentRequest);</span>
            
            // Create a new payment
<span class="fc" id="L30">            Payment payment = Payment.builder()</span>
<span class="fc" id="L31">                    .id(UUID.randomUUID().toString())</span>
<span class="fc" id="L32">                    .amount(paymentRequest.getAmount())</span>
<span class="fc" id="L33">                    .currencyCode(paymentRequest.getCurrencyCode())</span>
<span class="fc" id="L34">                    .requestingAgentId(paymentRequest.getRequestingAgentId())</span>
<span class="fc" id="L35">                    .receivingAgentId(paymentRequest.getReceivingAgentId())</span>
<span class="fc" id="L36">                    .description(paymentRequest.getDescription())</span>
<span class="fc" id="L37">                    .metadata(paymentRequest.getMetadata())</span>
<span class="fc" id="L38">                    .externalReference(paymentRequest.getExternalReference())</span>
<span class="fc" id="L39">                    .status(PaymentStatus.CREATED)</span>
<span class="fc" id="L40">                    .createdAt(Instant.now())</span>
<span class="fc" id="L41">                    .build();</span>
            
            // Store the payment
<span class="fc" id="L44">            paymentStore.put(payment.getId(), payment);</span>
            
            // Return the response
<span class="fc" id="L47">            return PaymentResponse.builder()</span>
<span class="fc" id="L48">                    .paymentId(payment.getId())</span>
<span class="fc" id="L49">                    .status(payment.getStatus())</span>
<span class="fc" id="L50">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L51">                    .authUrl(&quot;https://example.com/auth?paymentId=&quot; + payment.getId())</span>
<span class="fc" id="L52">                    .build();</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; authorizePayment(String paymentId, String authToken) {
<span class="fc" id="L58">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L59">            log.info(&quot;Authorizing payment: {}&quot;, paymentId);</span>
            
<span class="fc" id="L61">            Payment payment = paymentStore.get(paymentId);</span>
<span class="pc bpc" id="L62" title="1 of 2 branches missed.">            if (payment == null) {</span>
<span class="nc" id="L63">                return PaymentResponse.builder()</span>
<span class="nc" id="L64">                        .paymentId(paymentId)</span>
<span class="nc" id="L65">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L66">                        .errorCode(&quot;PAYMENT_NOT_FOUND&quot;)</span>
<span class="nc" id="L67">                        .errorMessage(&quot;Payment not found&quot;)</span>
<span class="nc" id="L68">                        .build();</span>
            }
            
            // Simulate authorization
<span class="fc" id="L72">            payment.setStatus(PaymentStatus.AUTHORIZED);</span>
<span class="fc" id="L73">            payment.setUpdatedAt(Instant.now());</span>
<span class="fc" id="L74">            paymentStore.put(paymentId, payment);</span>
            
<span class="fc" id="L76">            return PaymentResponse.builder()</span>
<span class="fc" id="L77">                    .paymentId(payment.getId())</span>
<span class="fc" id="L78">                    .status(payment.getStatus())</span>
<span class="fc" id="L79">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L80">                    .updatedAt(payment.getUpdatedAt())</span>
<span class="fc" id="L81">                    .build();</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; capturePayment(String paymentId) {
<span class="fc" id="L87">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L88">            log.info(&quot;Capturing payment: {}&quot;, paymentId);</span>
            
<span class="fc" id="L90">            Payment payment = paymentStore.get(paymentId);</span>
<span class="pc bpc" id="L91" title="1 of 2 branches missed.">            if (payment == null) {</span>
<span class="nc" id="L92">                return PaymentResponse.builder()</span>
<span class="nc" id="L93">                        .paymentId(paymentId)</span>
<span class="nc" id="L94">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L95">                        .errorCode(&quot;PAYMENT_NOT_FOUND&quot;)</span>
<span class="nc" id="L96">                        .errorMessage(&quot;Payment not found&quot;)</span>
<span class="nc" id="L97">                        .build();</span>
            }
            
<span class="pc bpc" id="L100" title="1 of 2 branches missed.">            if (payment.getStatus() != PaymentStatus.AUTHORIZED) {</span>
<span class="nc" id="L101">                return PaymentResponse.builder()</span>
<span class="nc" id="L102">                        .paymentId(paymentId)</span>
<span class="nc" id="L103">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L104">                        .errorCode(&quot;PAYMENT_NOT_AUTHORIZED&quot;)</span>
<span class="nc" id="L105">                        .errorMessage(&quot;Payment must be authorized before capture&quot;)</span>
<span class="nc" id="L106">                        .build();</span>
            }
            
            // Simulate capture
<span class="fc" id="L110">            payment.setStatus(PaymentStatus.COMPLETED);</span>
<span class="fc" id="L111">            payment.setUpdatedAt(Instant.now());</span>
<span class="fc" id="L112">            paymentStore.put(paymentId, payment);</span>
            
<span class="fc" id="L114">            return PaymentResponse.builder()</span>
<span class="fc" id="L115">                    .paymentId(payment.getId())</span>
<span class="fc" id="L116">                    .status(payment.getStatus())</span>
<span class="fc" id="L117">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L118">                    .updatedAt(payment.getUpdatedAt())</span>
<span class="fc" id="L119">                    .receiptUrl(&quot;https://example.com/receipt?paymentId=&quot; + payment.getId())</span>
<span class="fc" id="L120">                    .build();</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; cancelPayment(String paymentId) {
<span class="fc" id="L126">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L127">            log.info(&quot;Cancelling payment: {}&quot;, paymentId);</span>
            
<span class="fc" id="L129">            Payment payment = paymentStore.get(paymentId);</span>
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            if (payment == null) {</span>
<span class="nc" id="L131">                return PaymentResponse.builder()</span>
<span class="nc" id="L132">                        .paymentId(paymentId)</span>
<span class="nc" id="L133">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L134">                        .errorCode(&quot;PAYMENT_NOT_FOUND&quot;)</span>
<span class="nc" id="L135">                        .errorMessage(&quot;Payment not found&quot;)</span>
<span class="nc" id="L136">                        .build();</span>
            }
            
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (payment.getStatus() == PaymentStatus.COMPLETED) {</span>
<span class="nc" id="L140">                return PaymentResponse.builder()</span>
<span class="nc" id="L141">                        .paymentId(paymentId)</span>
<span class="nc" id="L142">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L143">                        .errorCode(&quot;PAYMENT_ALREADY_COMPLETED&quot;)</span>
<span class="nc" id="L144">                        .errorMessage(&quot;Cannot cancel a completed payment&quot;)</span>
<span class="nc" id="L145">                        .build();</span>
            }
            
            // Simulate cancellation
<span class="fc" id="L149">            payment.setStatus(PaymentStatus.CANCELED);</span>
<span class="fc" id="L150">            payment.setUpdatedAt(Instant.now());</span>
<span class="fc" id="L151">            paymentStore.put(paymentId, payment);</span>
            
<span class="fc" id="L153">            return PaymentResponse.builder()</span>
<span class="fc" id="L154">                    .paymentId(payment.getId())</span>
<span class="fc" id="L155">                    .status(payment.getStatus())</span>
<span class="fc" id="L156">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L157">                    .updatedAt(payment.getUpdatedAt())</span>
<span class="fc" id="L158">                    .build();</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; refundPayment(String paymentId, String reason) {
<span class="fc" id="L164">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L165">            log.info(&quot;Refunding payment: {}&quot;, paymentId);</span>
            
<span class="fc" id="L167">            Payment payment = paymentStore.get(paymentId);</span>
<span class="pc bpc" id="L168" title="1 of 2 branches missed.">            if (payment == null) {</span>
<span class="nc" id="L169">                return PaymentResponse.builder()</span>
<span class="nc" id="L170">                        .paymentId(paymentId)</span>
<span class="nc" id="L171">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L172">                        .errorCode(&quot;PAYMENT_NOT_FOUND&quot;)</span>
<span class="nc" id="L173">                        .errorMessage(&quot;Payment not found&quot;)</span>
<span class="nc" id="L174">                        .build();</span>
            }
            
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">            if (payment.getStatus() != PaymentStatus.COMPLETED) {</span>
<span class="nc" id="L178">                return PaymentResponse.builder()</span>
<span class="nc" id="L179">                        .paymentId(paymentId)</span>
<span class="nc" id="L180">                        .status(PaymentStatus.FAILED)</span>
<span class="nc" id="L181">                        .errorCode(&quot;PAYMENT_NOT_COMPLETED&quot;)</span>
<span class="nc" id="L182">                        .errorMessage(&quot;Only completed payments can be refunded&quot;)</span>
<span class="nc" id="L183">                        .build();</span>
            }
            
            // Simulate refund
<span class="fc" id="L187">            payment.setStatus(PaymentStatus.REFUNDED);</span>
<span class="fc" id="L188">            payment.setUpdatedAt(Instant.now());</span>
            
            // Add refund reason to metadata
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">            if (payment.getMetadata() == null) {</span>
<span class="fc" id="L192">                payment.setMetadata(new HashMap&lt;&gt;());</span>
            }
<span class="fc" id="L194">            payment.getMetadata().put(&quot;refundReason&quot;, reason);</span>
<span class="fc" id="L195">            paymentStore.put(paymentId, payment);</span>
            
<span class="fc" id="L197">            return PaymentResponse.builder()</span>
<span class="fc" id="L198">                    .paymentId(payment.getId())</span>
<span class="fc" id="L199">                    .status(payment.getStatus())</span>
<span class="fc" id="L200">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L201">                    .updatedAt(payment.getUpdatedAt())</span>
<span class="fc" id="L202">                    .build();</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;Optional&lt;Payment&gt;&gt; getPayment(String paymentId) {
<span class="fc" id="L208">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L209">            log.info(&quot;Getting payment: {}&quot;, paymentId);</span>
<span class="fc" id="L210">            return Optional.ofNullable(paymentStore.get(paymentId));</span>
        });
    }
    
    @Override
    public CompletableFuture&lt;PaymentResponse&gt; checkPaymentStatus(String paymentId) {
<span class="fc" id="L216">        return CompletableFuture.supplyAsync(() -&gt; {</span>
<span class="fc" id="L217">            log.info(&quot;Checking payment status: {}&quot;, paymentId);</span>
            
<span class="fc" id="L219">            Payment payment = paymentStore.get(paymentId);</span>
<span class="fc bfc" id="L220" title="All 2 branches covered.">            if (payment == null) {</span>
<span class="fc" id="L221">                return PaymentResponse.builder()</span>
<span class="fc" id="L222">                        .paymentId(paymentId)</span>
<span class="fc" id="L223">                        .status(PaymentStatus.FAILED)</span>
<span class="fc" id="L224">                        .errorCode(&quot;PAYMENT_NOT_FOUND&quot;)</span>
<span class="fc" id="L225">                        .errorMessage(&quot;Payment not found&quot;)</span>
<span class="fc" id="L226">                        .build();</span>
            }
            
<span class="fc" id="L229">            return PaymentResponse.builder()</span>
<span class="fc" id="L230">                    .paymentId(payment.getId())</span>
<span class="fc" id="L231">                    .status(payment.getStatus())</span>
<span class="fc" id="L232">                    .createdAt(payment.getCreatedAt())</span>
<span class="fc" id="L233">                    .updatedAt(payment.getUpdatedAt())</span>
<span class="fc" id="L234">                    .build();</span>
        });
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>